# 压测机资源管理和配置功能设计

## 1. 功能概述

### 1.1 功能描述
提供详细的压测机资源监控、精确的资源分配配置和透明的资源使用展示，让用户清楚了解每台压测机的资源状态和分配情况。

### 1.2 核心价值
- **资源透明化**: 实时显示压测机的详细资源状态
- **精确配置**: 支持精确到核心级别的资源分配
- **智能推荐**: 基于资源状态提供配置建议
- **可视化展示**: 直观的资源使用和分配图表

## 2. 压测机详情监控

### 2.1 实时资源监控

#### 2.1.1 监控指标
```
压测机资源监控指标:
├── CPU监控
│   ├── 总核心数
│   ├── 已使用核心数
│   ├── 使用率百分比
│   ├── 各核心使用情况
│   └── 负载平均值
├── 内存监控
│   ├── 总内存容量
│   ├── 已使用内存
│   ├── 可用内存
│   ├── 内存使用率
│   └── 缓存和缓冲区使用
├── 网络监控
│   ├── 网络带宽
│   ├── 入站流量
│   ├── 出站流量
│   ├── 连接数
│   └── 网络延迟
└── 磁盘监控
    ├── 磁盘容量
    ├── 已使用空间
    ├── 可用空间
    ├── IOPS
    └── 读写速度
```

#### 2.1.2 监控界面设计
```
压测机详情页面 - Machine-01
┌─────────────────────────────────────────────────────────────┐
│ 机器基本信息                                                │
├─────────────────────────────────────────────────────────────┤
│ 机器名称: Machine-01 | IP: 192.168.1.10 | 状态: 在线 ✅    │
│ 操作系统: Ubuntu 20.04 | Locust版本: 2.17.0               │
│ 最后心跳: 2024-01-20 14:30:00 | 运行时间: 5天12小时       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 实时资源状态                                                │
├─────────────────────────────────────────────────────────────┤
│ CPU使用情况:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 总核心: 8核 | 已使用: 3.2核 | 使用率: 40%              │ │
│ │ ┌─┬─┬─┬─┬─┬─┬─┬─┐                                     │ │
│ │ │█│█│█│█│ │ │ │ │ 核心使用情况                        │ │
│ │ │1│2│3│4│5│6│7│8│                                     │ │
│ │ └─└─└─└─└─└─└─└─┘                                     │ │
│ │ 负载: 1.2, 1.5, 1.8 (1分钟, 5分钟, 15分钟)            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 内存使用情况:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 总内存: 16GB | 已使用: 6.4GB | 可用: 9.6GB | 使用率: 40% │ │
│ │ ████████████████████████████████████████████████████████ │ │
│ │ 已使用: 6.4GB | 缓存: 2.1GB | 缓冲区: 1.2GB            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 网络使用情况:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 带宽: 1Gbps | 入站: 45Mbps | 出站: 120Mbps | 使用率: 16.5% │ │
│ │ 连接数: 156 | 延迟: 2ms | 丢包率: 0%                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 磁盘使用情况:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 总容量: 500GB | 已使用: 120GB | 可用: 380GB | 使用率: 24% │ │
│ │ IOPS: 读取 150/s | 写入 80/s | 平均延迟: 5ms            │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 当前任务分配                                                │
├─────────────────────────────────────────────────────────────┤
│ 任务名称: 用户登录API压测 | 开始时间: 14:00:00             │
│                                                             │
│ 角色分配:                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Master角色:                                             │ │
│ │ - 分配核心: 1核 (核心1)                                │ │
│ │ - 分配内存: 2GB                                        │ │
│ │ - 分配网络: 100Mbps                                    │ │
│ │ - 当前使用: CPU 15% | 内存 1.8GB | 网络 45Mbps        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Worker-1角色:                                           │ │
│ │ - 分配核心: 3.5核 (核心2,3,4,5)                        │ │
│ │ - 分配内存: 7GB                                        │ │
│ │ - 分配网络: 450Mbps                                    │ │
│ │ - 当前使用: CPU 85% | 内存 6.2GB | 网络 380Mbps       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Worker-2角色:                                           │ │
│ │ - 分配核心: 3.5核 (核心6,7,8)                          │ │
│ │ - 分配内存: 7GB                                        │ │
│ │ - 分配网络: 450Mbps                                    │ │
│ │ - 当前使用: CPU 78% | 内存 5.8GB | 网络 420Mbps       │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 操作选项                                                    │
├─────────────────────────────────────────────────────────────┤
│ [配置新任务] [停止当前任务] [查看历史任务] [机器设置]      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 历史资源趋势

#### 2.2.1 趋势图表
```
资源使用趋势图表
┌─────────────────────────────────────────────────────────────┐
│ 时间范围: [最近1小时] [最近24小时] [最近7天] [自定义]      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ CPU使用趋势:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 100% ┤                                                  │ │
│ │  80% ┤     ●                                            │ │
│ │  60% ┤   ●   ●                                          │ │
│ │  40% ┤ ●       ●                                        │ │
│ │  20% ┤           ●                                      │ │
│ │   0% └───────────────────────────────────────────────── │ │
│ │     14:00 14:15 14:30 14:45 15:00                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 内存使用趋势:                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 16GB ┤                                                  │ │
│ │ 12GB ┤     ●                                            │ │
│ │  8GB ┤   ●   ●                                          │ │
│ │  4GB ┤ ●       ●                                        │ │
│ │  0GB ┤           ●                                      │ │
│ │      └───────────────────────────────────────────────── │ │
│ │     14:00 14:15 14:30 14:45 15:00                      │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 3. 精确资源分配配置

### 3.1 资源分配配置界面

#### 3.1.1 配置界面设计
```
压测任务资源配置
┌─────────────────────────────────────────────────────────────┐
│ 任务基本信息                                                │
├─────────────────────────────────────────────────────────────┤
│ 任务名称: [用户登录API压测]                               │
│ 目标API: [POST /api/v1/auth/login]                        │
│ 压测机: [Machine-01] ▼                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 机器资源概览                                                │
├─────────────────────────────────────────────────────────────┤
│ 机器配置: 8核CPU, 16GB内存, 1Gbps网络, 500GB磁盘          │
│ 当前可用: 8核CPU, 16GB内存, 1Gbps网络, 500GB磁盘          │
│ 系统预留: 0.5核CPU, 1GB内存, 50Mbps网络, 20GB磁盘        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 角色资源配置                                                │
├─────────────────────────────────────────────────────────────┤
│ 配置模式: [精确配置] [智能推荐] [模板配置]                │
│                                                             │
│ Master角色配置:                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ☑️ 启用Master角色                                       │ │
│ │                                                         │ │
│ │ CPU分配:                                                │ │
│ │ - 分配方式: [固定核心] [百分比] [自动]                 │ │
│ │ - 核心数量: [1] 核                                      │ │
│ │ - 核心选择: [核心1] [核心2] [核心3] [核心4]            │ │
│ │ - 使用限制: [无限制] [最大80%] [最大90%]               │ │
│ │                                                         │ │
│ │ 内存分配:                                                │ │
│ │ - 分配方式: [固定大小] [百分比] [自动]                 │ │
│ │ - 内存大小: [2] GB                                      │ │
│ │ - 使用限制: [无限制] [最大90%] [最大95%]               │ │
│ │                                                         │ │
│ │ 网络分配:                                                │ │
│ │ - 分配方式: [固定带宽] [百分比] [自动]                 │ │
│ │ - 网络带宽: [100] Mbps                                  │ │
│ │ - 使用限制: [无限制] [最大90%] [最大95%]               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ Worker角色配置:                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Worker数量: [2] 个                                      │ │
│ │                                                         │ │
│ │ Worker-1配置:                                           │ │
│ │ - CPU分配: [3.5] 核 (核心2,3,4,5)                      │ │
│ │ - 内存分配: [7] GB                                      │ │
│ │ - 网络分配: [450] Mbps                                  │ │
│ │ - 用户数: [2500] 用户                                   │ │
│ │                                                         │ │
│ │ Worker-2配置:                                           │ │
│ │ - CPU分配: [3.5] 核 (核心6,7,8)                        │ │
│ │ - 内存分配: [7] GB                                      │ │
│ │ - 网络分配: [450] Mbps                                  │ │
│ │ - 用户数: [2500] 用户                                   │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 资源分配验证                                                │
├─────────────────────────────────────────────────────────────┤
│ 总资源分配:                                                │
│ - CPU: 8/8 核 (100%) ✅                                   │
│ - 内存: 16/16 GB (100%) ✅                                │
│ - 网络: 1000/1000 Mbps (100%) ✅                          │
│ - 磁盘: 20/500 GB (4%) ✅                                 │
│                                                             │
│ 分配合理性检查:                                            │
│ ✅ Master角色资源充足                                      │
│ ✅ Worker角色资源均衡                                      │
│ ✅ 系统预留资源充足                                        │
│ ⚠️ 建议为系统预留更多CPU资源                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 操作选项                                                    │
├─────────────────────────────────────────────────────────────┤
│ [保存配置] [预览配置] [应用配置] [重置配置]                │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 智能推荐配置

#### 3.2.1 推荐算法
```
智能推荐配置:
├── 基于机器性能推荐
│   ├── 高性能机器: 推荐更多Worker
│   ├── 中等性能机器: 推荐平衡配置
│   └── 低性能机器: 推荐保守配置
├── 基于测试需求推荐
│   ├── 高并发测试: 推荐多Worker配置
│   ├── 长时间测试: 推荐资源预留
│   └── 复杂测试: 推荐Master+Worker配置
└── 基于历史数据推荐
    ├── 成功配置推荐
    ├── 性能优化推荐
    └── 资源利用率推荐
```

#### 3.2.2 推荐界面
```
智能配置推荐
┌─────────────────────────────────────────────────────────────┐
│ 推荐配置方案                                                │
├─────────────────────────────────────────────────────────────┤
│ 方案1: 均衡配置 (推荐)                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Master: 1核, 2GB, 100Mbps                              │ │
│ │ Worker-1: 3.5核, 7GB, 450Mbps                          │ │
│ │ Worker-2: 3.5核, 7GB, 450Mbps                          │ │
│ │ 适用场景: 中等负载测试                                  │ │
│ │ 预期性能: 5000用户, 800 RPS                            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 方案2: 高性能配置                                          │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Master: 0.5核, 1GB, 50Mbps                             │ │
│ │ Worker-1: 4核, 8GB, 500Mbps                            │ │
│ │ Worker-2: 3.5核, 7GB, 450Mbps                          │ │
│ │ 适用场景: 高负载测试                                    │ │
│ │ 预期性能: 8000用户, 1200 RPS                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 方案3: 保守配置                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Master: 1.5核, 3GB, 150Mbps                            │ │
│ │ Worker-1: 3核, 6GB, 400Mbps                            │ │
│ │ Worker-2: 3.5核, 7GB, 450Mbps                          │ │
│ │ 适用场景: 稳定性优先                                    │ │
│ │ 预期性能: 3000用户, 600 RPS                            │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 推荐理由                                                    │
├─────────────────────────────────────────────────────────────┤
│ 💡 推荐方案1的原因:                                        │
│ • 资源分配均衡，避免单点过载                              │
│ • 适合大多数测试场景                                      │
│ • 系统稳定性好                                            │
│ • 历史成功率: 95%                                         │
│                                                             │
│ ⚠️ 注意事项:                                               │
│ • 建议在测试前进行资源预热                                │
│ • 监控系统资源使用情况                                    │
│ • 根据实际测试结果调整配置                                │
└─────────────────────────────────────────────────────────────┘
```

## 4. 资源分配策略

### 4.1 分配策略类型

#### 4.1.1 固定分配策略
```
固定分配策略:
├── 核心分配
│   ├── 指定具体核心编号
│   ├── 固定核心数量
│   └── 核心使用限制
├── 内存分配
│   ├── 固定内存大小
│   ├── 内存使用限制
│   └── 内存预留策略
└── 网络分配
    ├── 固定带宽分配
    ├── 网络使用限制
    └── 网络优先级设置
```

#### 4.1.2 动态分配策略
```
动态分配策略:
├── 基于负载分配
│   ├── 根据CPU负载调整
│   ├── 根据内存使用调整
│   └── 根据网络流量调整
├── 基于性能分配
│   ├── 根据响应时间调整
│   ├── 根据吞吐量调整
│   └── 根据错误率调整
└── 基于优先级分配
    ├── 高优先级任务优先
    ├── 关键任务资源保障
    └── 资源争用处理
```

### 4.2 资源隔离机制

#### 4.2.1 进程隔离
```
进程隔离机制:
├── CPU隔离
│   ├── CPU亲和性设置
│   ├── CPU核心绑定
│   └── CPU使用限制
├── 内存隔离
│   ├── 内存限制设置
│   ├── 内存使用监控
│   └── 内存溢出保护
└── 网络隔离
    ├── 网络带宽限制
    ├── 网络连接限制
    └── 网络优先级设置
```

#### 4.2.2 容器隔离
```
容器隔离机制:
├── Docker容器
│   ├── 资源限制配置
│   ├── 网络隔离
│   └── 存储隔离
├── 资源监控
│   ├── 容器资源使用
│   ├── 资源限制监控
│   └── 异常告警
└── 自动恢复
    ├── 资源超限处理
    ├── 容器重启机制
    └── 故障转移
```

## 5. 配置验证和优化

### 5.1 配置验证

#### 5.1.1 验证规则
```
配置验证规则:
├── 资源充足性验证
│   ├── 总资源是否足够
│   ├── 各角色资源是否合理
│   └── 系统预留是否充足
├── 配置合理性验证
│   ├── 角色配置是否合理
│   ├── 资源分配是否均衡
│   └── 性能预期是否可达
└── 兼容性验证
    ├── 硬件兼容性检查
    ├── 软件兼容性检查
    └── 网络连通性检查
```

#### 5.1.2 验证界面
```
配置验证结果
┌─────────────────────────────────────────────────────────────┐
│ 验证结果概览                                                │
├─────────────────────────────────────────────────────────────┤
│ 验证状态: ✅ 通过 | 验证时间: 2024-01-20 14:30:00         │
│ 验证项目: 8项 | 通过: 7项 | 警告: 1项 | 失败: 0项        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 详细验证结果                                                │
├─────────────────────────────────────────────────────────────┤
│ 验证项目        │ 状态    │ 结果说明                      │
├─────────────────────────────────────────────────────────────┤
│ 资源充足性      │ ✅ 通过 │ 总资源充足，分配合理          │
│ 角色配置        │ ✅ 通过 │ Master和Worker配置合理        │
│ 核心分配        │ ✅ 通过 │ 核心分配无冲突                │
│ 内存分配        │ ✅ 通过 │ 内存分配充足                  │
│ 网络分配        │ ✅ 通过 │ 网络带宽充足                  │
│ 系统预留        │ ⚠️ 警告 │ 建议增加系统预留资源          │
│ 性能预期        │ ✅ 通过 │ 预期性能可达                  │
│ 兼容性检查      │ ✅ 通过 │ 硬件软件兼容                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 优化建议                                                    │
├─────────────────────────────────────────────────────────────┤
│ 💡 建议优化:                                                │
│ • 建议为系统预留0.5核CPU和1GB内存                         │
│ • 建议设置资源使用上限为90%                                │
│ • 建议添加资源监控告警                                     │
│                                                             │
│ 🚀 性能优化:                                                │
│ • 可以尝试增加Worker数量提高并发                           │
│ • 可以优化网络配置提高吞吐量                               │
│ • 可以调整等待时间提高效率                                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 配置优化

#### 5.2.1 优化策略
```
配置优化策略:
├── 性能优化
│   ├── 提高并发能力
│   ├── 优化资源利用
│   └── 减少资源浪费
├── 稳定性优化
│   ├── 增加系统预留
│   ├── 设置资源限制
│   └── 添加故障恢复
└── 成本优化
    ├── 提高资源利用率
    ├── 减少资源浪费
    └── 优化配置策略
```

## 6. 监控和告警

### 6.1 实时监控

#### 6.1.1 监控指标
```
实时监控指标:
├── 资源使用监控
│   ├── CPU使用率
│   ├── 内存使用率
│   ├── 网络使用率
│   └── 磁盘使用率
├── 性能指标监控
│   ├── 响应时间
│   ├── 吞吐量
│   ├── 错误率
│   └── 并发数
└── 系统健康监控
    ├── 进程状态
    ├── 服务状态
    ├── 网络状态
    └── 存储状态
```

#### 6.1.2 告警机制
```
告警机制:
├── 资源告警
│   ├── CPU使用率 > 90%
│   ├── 内存使用率 > 90%
│   ├── 网络使用率 > 80%
│   └── 磁盘使用率 > 85%
├── 性能告警
│   ├── 响应时间 > 阈值
│   ├── 错误率 > 5%
│   ├── 吞吐量 < 预期
│   └── 并发数异常
└── 系统告警
    ├── 进程异常退出
    ├── 服务不可用
    ├── 网络连接失败
    └── 存储空间不足
```

## 7. 总结

这个压测机资源管理功能设计提供了：

1. **透明的资源监控**: 实时显示详细的资源使用情况
2. **精确的资源配置**: 支持精确到核心级别的资源分配
3. **智能的配置推荐**: 基于机器性能和测试需求提供配置建议
4. **完善的验证机制**: 确保配置的合理性和可行性
5. **实时的监控告警**: 及时发现和处理资源异常

通过这些功能，用户可以清楚地了解压测机的资源状态，精确配置资源分配，确保压测任务的稳定执行。
